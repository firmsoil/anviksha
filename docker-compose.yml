version: '3.8'
services:
  # 1. MongoDB Service
  mongo:
    image: mongo:latest
    container_name: mongodb_cicd
    volumes:
      - mongo-data:/data/db
    ports:
      - "27017:27017"
    restart: always
  
  # 2. FastAPI Application Service
  app:
    build: . # Build using the Dockerfile in the current directory
    container_name: fastapi_analytics
    ports:
      - "8080:8080" # ðŸ‘ˆ CORRECTED PORT MAPPING
    depends_on:
      - mongo # Ensure mongo starts before the app
    environment:
      - MONGO_URI=mongodb://mongo:27017/
      - DB_NAME=cicd_db
      - OPENAI_API_KEY=${OPENAI_API_KEY} 

volumes:
  mongo-data: 
```

## ðŸš€ Step 3: Clean Up, Rebuild, and Start

We must remove the failed container, rebuild the image with the correct `CMD`, and restart the services.

1.  **Stop and Remove Existing Services:**
    This command stops the running MongoDB service and removes the remnants of the failed `fastapi_analytics` container.

    ```bash
    docker compose down
    ```

2.  **Ensure OpenAI Key is Exported:**

    ```bash
    export OPENAI_API_KEY="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
    ```

3.  **Rebuild and Start Services:**
    The `--build` flag is essential to use the newly edited `Dockerfile`.

    ```bash
    docker compose up --build -d
    ```

4.  **Verify Status:**
    Check that both containers are now running.

    ```bash
    docker compose ps
    ```
    * **Expected Result:** Both `mongodb_cicd` and `fastapi_analytics` should show `Status: running`.

5.  **Load Sample Data (Success Execution):**
    The container is running, so now the `docker exec` command will succeed.

    ```bash
    docker exec fastapi_analytics python load_data.py
    
