version: '3.8'
services:
  # 1. MongoDB Service
  mongo:
    image: mongo:latest
    container_name: mongodb_cicd
    volumes:
      - mongo-data:/data/db
    ports:
      - "27017:27017"
    restart: always
  
  # 2. FastAPI Application Service
  app:
    build: . # Build using the Dockerfile in the current directory
    container_name: fastapi_analytics
    ports:
      - "8080:8080" # CORRECTED PORT MAPPING to match Dockerfile
    depends_on:
      - mongo # Ensure mongo starts before the app
    environment:
      - MONGO_URI=mongodb://mongo:27017/
      - DB_NAME=cicd_db
      # This line often causes issues if not properly set/escaped
      - OPENAI_API_KEY=${OPENAI_API_KEY} 

# ----------------- Line 27: The top-level 'volumes' section -----------------
volumes: 
# ----------------- Line 28: The definition of the named volume (2 spaces) ---
  mongo-data:
