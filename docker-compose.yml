services:
  # 1. MongoDB Service
  mongo:
    image: mongo:latest
    container_name: mongodb_cicd
    volumes:
      - mongo-data:/data/db
    ports:
      - "27017:27017"
    restart: always
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
  
  # 2. Simple Mock MCP Server (Temporary Solution)
  # Using a lightweight Python FastAPI server that mimics MCP functionality
  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile.mcp
    container_name: mcp_toolbox_server
    ports:
      - "3000:3000"
    environment:
      - MONGODB_URI=mongodb://mongo:27017/
      - MONGODB_DATABASE=cicd_db
      - PORT=3000
    depends_on:
      mongo:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
  
  # 3. FastAPI Application Service
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fastapi_analytics
    ports:
      - "8080:8080"
    depends_on:
      mongo:
        condition: service_healthy
      mcp-server:
        condition: service_healthy
    environment:
      - MONGO_URI=mongodb://mongo:27017/
      - MONGO_HOST=mongo
      - MONGO_PORT=27017
      - DB_NAME=cicd_db
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      
      # MCP Server configuration
      - MCP_SERVER_URL=http://mcp-server:3000
      - MCP_ENABLED=true
      - MCP_CACHE_TTL=300
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes: 
  mongo-data:
